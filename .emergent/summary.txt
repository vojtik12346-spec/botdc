<analysis>**original_problem_statement:**
Původní požadavek byl na Discord bota s kvízy a herním XP systémem. Požadavky se rozšířily o:
1.  **Herní a kvízové příkazy:** , , , , , , , .
2.  **XP a Level Systém:** Sběr XP za aktivitu v kvízech a za hraní her na PC, včetně úkolů a denních odměn.
3.  **Administrace a Notifikace:** Omezení kvízů na adminy, směrování notifikací do určeného kanálu a pingnutí role.
4.  **Přejmenování a Rebranding:** Změna jména a textů bota na Valhalla Bot.
5.  **Webový Admin Panel:** Vytvoření webového rozhraní (jako MEE6) pro správu bota, které vyžaduje přihlášení přes Discord. Panel má zobrazovat statistiky, žebříčky, profily hráčů a umožňovat nastavení bota pro konkrétní server.
6.  **Nové Funkce Bota:**
    *   Giveaway systém ().
    *   Statistiky serveru () s interaktivními tlačítky.
    *   Hudební přehrávač pro přehrávání z YouTube a rádiových stanic.

**User's preferred language**: čeština

**what currently exists?**
-   **Backend ():** Plně funkční Discord bot s kvízy, komplexním XP/level systémem, sledováním herní aktivity, giveaway systémem, statistikami serveru a přehráváním rádia. Všechna logika je v tomto monolitickém souboru.
-   **Backend ():** FastAPI server, který obsluhuje webový admin panel. Obsahuje API endpointy pro Discord OAuth2 autentizaci, získávání statistik serveru, žebříčků, profilů hráčů a načítání nastavení bota.
-   **Frontend (, ):** React aplikace, která slouží jako webový admin panel. Obsahuje landing page s tlačítky Přidat na Discord a Přihlásit se. Po přihlášení zobrazí seznam serverů, kde je uživatel admin, a umožňuje přístup k dashboardu s nastaveními a statistikami pro vybraný server.
-   **Database (MongoDB):** Ukládá data o uživatelích (), serverech (), statistikách (, ) a další.

**Last working item**:
-   **Last item agent was working**: Uživatel požádal o opravu příkazu , konkrétně zobrazení statistik Celkový čas hraní a Dnešní XP za hry, které nezobrazovaly správná data. Zároveň chtěl odstranit hru Counter-Strike: Global Offensive a ponechat pouze Counter-Strike 2. Agent provedl úpravy v souboru  k nápravě těchto problémů.
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Manual testing on Discord. Je potřeba, aby uživatel spustil příkaz  a ověřil, že:
    1.  Hra Counter-Strike: Global Offensive již není v seznamu her.
    2.  Pole Celkový čas hraní a Dnešní XP za hry nyní zobrazují správné hodnoty a postup.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: Přehrávání hudby z YouTube a Spotify nefunguje (P0)
-   **Issue 2**: Propojení nastavení oprávnění z webového panelu s botem (P1)

**Issues Detail**:
-   **Issue 1**: Přehrávání hudby z YouTube a Spotify nefunguje
    -   **Attempted fixes**: Agent se pokusil implementovat přehrávání z YouTube pomocí . Všechny pokusy selhaly kvůli chybě , což znamená, že YouTube aktivně blokuje požadavky z cloudového hostingu. Agent správně identifikoval, že Spotify API neposkytuje přímé audio streamy. Jako workaround implementoval přehrávání rádiových stanic přes přímé stream URL, což funguje.
    -   **Next debug checklist**:
        1.  Jasně komunikovat uživateli, že YouTube/Spotify je na tomto hostingu blokováno a nelze to snadno obejít.
        2.  Navrhnout alternativy:
            *   Rozšířit seznam rádiových stanic v příkazu .
            *   Nabídnout uživateli pomoc s přípravou bota pro lokální hostování na jeho vlastním PC, kde by YouTube fungovalo.
    -   **Why fix this issue and what will be achieved with the fix?**: Jedná se o klíčovou funkci, kterou si uživatel přál.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: Hosting/External Service Limitation

-   **Issue 2**: Propojení nastavení oprávnění z webového panelu s botem
    -   **Attempted fixes**: Žádné. Agent vytvořil na frontendu přepínače (toggles) pro nastavení oprávnění příkazů (Admin/Všichni), ale tato nastavení se nikam neukládají a bot na ně nereaguje.
    -   **Next debug checklist**:
        1.  V  upravit endpoint pro ukládání nastavení () tak, aby přijímal a ukládal do databáze (kolekce ) oprávnění pro jednotlivé příkazy.
        2.  Ve  implementovat logiku, která při kliknutí na Uložit nastavení odešle aktuální stav přepínačů na tento API endpoint.
        3.  V  upravit logiku pro kontrolu oprávnění u každého příkazu tak, aby se nejprve podívala na konfiguraci v databázi pro daný server, a až poté použila výchozí hodnotu.
    -   **Why fix this issue and what will be achieved with the fix?**: Dokončí se klíčová funkce admin panelu a umožní se dynamická správa bota bez nutnosti úpravy kódu.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None

**In progress Task List**:
-   Žádné.

**Upcoming and Future Tasks**
-   **Emoji kvíz** (): Hádání filmu/seriálu podle emoji. (P1)
-   **Matematický kvíz** (): Rychlé matematické úlohy. (P2)
-   **Moderace:** Příkazy  a logování. (P2)
-   **Uvítací zprávy:** Automatická zpráva pro nové členy. (P2)
-   **Reaction roles:** Získání role kliknutím na emoji reakci. (P2)
-   **Web Dashboard - Historie kvízů:** Dokončit implementaci zobrazení historie odehraných kvízů. (P2)

**Completed work in this session**
-   Opraven problém s odesíláním notifikací do špatného kanálu.
-   Změněno automatické mazání odpovědí bota z 5 minut na 1 minutu.
-   Implementován příkaz  pro zobrazení trvalé zprávy s nápovědou.
-   Bot byl přejmenován na Valhalla Bot, včetně všech textů a embedů.
-   Kompletně přestavěn frontend na webový admin panel ve stylu MEE6.
-   Implementován plnohodnotný Discord OAuth2 login pro webový panel.
-   Do admin panelu přidány živé statistiky, žebříček hráčů a profily hráčů.
-   Implementován giveaway systém s příkazy  a .
-   Implementován příkaz  s interaktivními tlačítky pro zobrazení statistik serveru.
-   Jako workaround pro blokovaný YouTube byl implementován robustní  systém s více než 35 stanicemi.
-   Opraven příkaz  pro správné zobrazení herních statistik.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: Monolitický soubor 
    -   **Debug checklist**: Rozdělit soubor  (nyní přes 4500 řádků) do samostatných modulů (Cogs) podle funkcionality (např. , , , ).
    -   **Why to solve this issue and what will be achieved with this?**: Současný stav je neudržitelný, zpomaluje vývoj a zvyšuje riziko zanesení chyb. Refaktoring zlepší čitelnost, spravovatelnost a stabilitu kódu.
    -   **Should Test frontend/backend/both after fix**: backend
    -   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
-   Problém s notifikacemi do špatného kanálu byl v této session opraven.

**Code Architecture**


**Key Technical Concepts**
-   **Backend**: Python,  (včetně , , , ), FastAPI, MongoDB (), Supervisor, .
-   **Frontend**: JavaScript, React, CSS.
-   **Authentication**: Discord OAuth2 pro přihlášení na web.
-   **Database**: MongoDB.

**key DB schema**
-   ****: Data o uživatelích (XP, level, statistiky her, úkoly).
-   ****: Konfigurace pro jednotlivé servery (ID kanálů, role, oprávnění příkazů - zatím neimplementováno).
-   ****: Agregovaná data o aktivitě na serveru (zprávy, voice).
-   ****: Globální statistiky bota (počet serverů).

**changes in tech stack**
-   Přidány  a  pro hudební funkce.

**All files of reference**
-    (Hlavní soubor s logikou bota)
-    (Backend pro web)
-    (Frontend pro web)
-    (Styly pro web)
-    (Klíče a konfigurace)

**Areas that need refactoring**:
-   Soubor  je kriticky nutné refaktorovat do menších, spravovatelných modulů (Cogs). Přidáním hudebního systému, statistik a giveaways se jeho velikost stala neudržitelnou.

**key api endpoints**
-   : Výměna OAuth kódu za token.
-   : Získání dat o přihlášeném uživateli.
-   : Seznam serverů, kde je bot.
-   : Získání dat pro žebříček.
-   : Získání dat pro profil hráče.
-   : Získání statistik pro dashboard.
-   : Získání nastavení pro server.
-   : Uložení nastavení pro server (zatím nepropojeno).

**Critical Info for New Agent**
-   **YouTube/Spotify je blokováno!** Neplýtvejte časem na pokusy o opravu. Zaměřte se na alternativy, jako je rozšíření  příkazu, nebo komunikujte s uživatelem o možnosti lokálního hostování.
-   **Webový panel není plně funkční.** Přepínače oprávnění na záložce Příkazy jsou pouze UI prvek. Je třeba implementovat backendovou logiku pro jejich ukládání a použití.
-   **Refaktoring je nutný.** Práce se souborem  je velmi obtížná. Navrhněte uživateli refaktoring jako prioritu pro zlepšení stability a budoucího vývoje.
-   Komunikujte s uživatelem v **češtině**.

**documents and test reports created in this job**
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **user**: funguje co dal ? (po implementaci )
2.  **agent**: Navrhuje nové funkce (hry, moderace, automatizace).
3.  **user**: Požaduje opravu  (zobrazení času hraní a denních XP) a odstranění hry Counter-Strike: Global Offensive.
4.  **agent**: Začíná s analýzou a opravou.
5.  **agent**: Upravuje kód  pro opravu zobrazení statistik a odstranění hry.
6.  **agent**: Dokončil implementaci a žádá uživatele o otestování.

**Project Health Check:**
-   **Broken**: Přehrávání hudby z YouTube/Spotify.
-   **Mocked**: Funkce pro ukládání nastavení oprávnění příkazů z webového admin panelu. Přepínače v UI existují, ale nejsou napojeny na backend.

**3rd Party Integrations**
-   **Discord API** (přes )
-   **MongoDB** (přes )
-   **yt-dlp**: Pro přehrávání audia z přímých streamů (rádia).

**Testing status**
-   **testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: []
-   **Known regressions**: None

**Credentials to test flow:**
-   Všechny potřebné tokeny a klíče jsou v .

**What agent forgot to execute**
-   Agent nepropojil UI přepínače pro oprávnění příkazů ve webovém panelu s backendovou logikou. Uživatel tak může měnit nastavení, ale reálně se nic neděje.</analysis>
